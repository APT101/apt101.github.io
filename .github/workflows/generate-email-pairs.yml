name: Generate & Append Email Pairs

on:
  workflow_dispatch:
    inputs:
      topics:
        description: "Optional topics hint (e.g., HR|Payroll|MFA|VPN|Okta)"
        required: false
        type: string
      pairs:
        description: "How many PAIRS (default 10). 10 pairs = 20 emails."
        required: false
        type: number
  # Weekly auto-run (Mon 03:23 UTC) â€” change if you prefer a different schedule
  schedule:
    - cron: "23 3 * * 1"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (no repo pollution)
        run: |
          npm init -y
          npm i openai

      - name: Run generator (build_email_pairs.mjs)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EMAIL_TOPICS: ${{ github.event.inputs.topics }}
          PAIRS_COUNT: ${{ github.event.inputs.pairs }}
        run: node scripts/build_email_pairs.mjs

      - name: Validate result (validate_email_pairs.mjs)
        run: node scripts/validate_email_pairs.mjs

      # NEW: move run artifacts into archive/ so root stays clean
      - name: Move artifacts into archive
        shell: bash
        run: |
          mkdir -p archive
          shopt -s nullglob
          # move any generated_email_pairs_*.json created by old runs or by script
          for f in generated_email_pairs_*.json; do
            mv "$f" "archive/$f"
          done
          # move npm metadata created during the run
          if [[ -f package.json ]]; then mv package.json archive/package.json; fi
          if [[ -f package-lock.json ]]; then mv package-lock.json archive/package-lock.json; fi
          # ensure we don't ever commit node_modules
          rm -rf node_modules

      - name: Commit & push results
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(emails): archive old, generate new pairs, validate; move artifacts to archive/"
            git push
          else
            echo "No changes to commit."
          fi
