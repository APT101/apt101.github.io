name: Generate & Append Email Pairs

on:
  workflow_dispatch:
    inputs:
      topics:
        description: "Optional topics hint (e.g., HR|Payroll|MFA|VPN|Okta)"
        required: false
        type: string
      pairs:
        description: "How many PAIRS (default 10). 10 pairs = 20 emails."
        required: false
        type: number
      min_words:
        description: "Minimum words per email body (default 50)."
        required: false
        type: number
      max_words:
        description: "Maximum words per email body (default 400)."
        required: false
        type: number
      attachment_rate:
        description: "Approx. percent of emails with attachments (default 50)."
        required: false
        type: number
  # Weekly auto-run (Mon 03:23 UTC) â€” adjust if you want
  schedule:
    - cron: "23 3 * * 1"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (no repo pollution)
        run: |
          npm init -y
          npm i openai

      - name: Run generator (build_email_pairs.mjs)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EMAIL_TOPICS: ${{ github.event.inputs.topics }}
          PAIRS_COUNT: ${{ github.event.inputs.pairs }}
          MIN_WORDS: ${{ github.event.inputs.min_words }}
          MAX_WORDS: ${{ github.event.inputs.max_words }}
          ATTACHMENT_RATE: ${{ github.event.inputs.attachment_rate }}
        run: node scripts/build_email_pairs.mjs

      - name: Validate result (validate_email_pairs.mjs)
        run: node scripts/validate_email_pairs.mjs

      # keep repo root clean
      - name: Move artifacts into archive
        shell: bash
        run: |
          mkdir -p archive
          shopt -s nullglob
          for f in generated_email_pairs_*.json; do
            mv "$f" "archive/$f"
          done
          if [[ -f package.json ]]; then mv package.json archive/package.json; fi
          if [[ -f package-lock.json ]]; then mv package-lock.json archive/package-lock.json; fi
          rm -rf node_modules

      - name: Commit & push results
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(emails): archive old, generate new pairs (len/attachments), validate; move artifacts to archive/"
            git push
          else
            echo "No changes to commit."
          fi
